<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="CM Trip" />
  <meta name="theme-color" content="#0F1419" />
  <meta name="description" content="Chiang Mai Travel Companion - Your complete trip organizer" />
  <title>Chiang Mai Trip Companion</title>

  <!-- PWA Manifest (inline via data URI) -->
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkNoaWFuZyBNYWkgVHJpcCBDb21wYW5pb24iLAogICJzaG9ydF9uYW1lIjogIkNNIFRyaXAiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzBGMTQxOSIsCiAgInRoZW1lX2NvbG9yIjogIiMwRjE0MTkiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCw8c3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgd2lkdGg9JzUxMicgaGVpZ2h0PSc1MTInIHZpZXdCb3g9JzAgMCA1MTIgNTEyJz48cmVjdCB3aWR0aD0nNTEyJyBoZWlnaHQ9JzUxMicgZmlsbD0nJTIzMEYxNDE5Jy8+PHRleHQgeD0nMjU2JyB5PScyODAnIGZvbnQtc2l6ZT0nMjAwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmaWxsPSclMjNENEFGMzcnPuKbqTwvdGV4dD48L3N2Zz4iLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiLAogICAgICAicHVycG9zZSI6ICJhbnkgbWFza2FibGUiCiAgICB9CiAgXQp9" />

  <!-- Apple Touch Icon -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='180' height='180' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='%230F1419'/><text x='90' y='105' font-size='80' text-anchor='middle' fill='%23D4AF37'>‚õ©</text></svg>" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Sans:wght@400;500;600;700&family=Cormorant+Garamond:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { 
      background: #0F1419; color: #fff; font-family: 'DM Sans', sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      overscroll-behavior: none; overflow-x: hidden; min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
    }
    ::-webkit-scrollbar { width: 0; height: 0; }
    input::placeholder, select { color: rgba(255,255,255,0.3); }
    input:focus, select:focus { outline: none; border-color: rgba(212,175,55,0.5) !important; }
    select option { background: #1A1F2E; color: #fff; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(14px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    @keyframes spin { to { transform: rotate(360deg); } }

    .app-root { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; }

    /* Background */
    .animated-bg { position: fixed; inset: 0; z-index: 0; overflow: hidden; pointer-events: none; }
    .animated-bg::before {
      content: ''; position: absolute; inset: 0;
      background: linear-gradient(165deg, #0F1419 0%, #1A1F2E 30%, #1E2636 50%, #1A2332 70%, #0F1419 100%);
    }
    .animated-bg .orb1 {
      position: absolute; top: -20%; right: -15%; width: 500px; height: 500px; border-radius: 50%;
      background: radial-gradient(circle, rgba(212,175,55,0.08) 0%, transparent 70%); filter: blur(60px);
    }
    .animated-bg .orb2 {
      position: absolute; bottom: -10%; left: -10%; width: 400px; height: 400px; border-radius: 50%;
      background: radial-gradient(circle, rgba(239,68,68,0.05) 0%, transparent 70%); filter: blur(50px);
    }

    /* Glass */
    .glass {
      background: rgba(255,255,255,0.04); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.08); border-radius: 16px;
    }
    .glass-active { border-color: rgba(212,175,55,0.3) !important; }

    /* Inputs & Buttons */
    .input {
      width: 100%; padding: 10px 14px; border-radius: 10px; font-size: 13px;
      border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05);
      color: #fff; font-family: 'DM Sans', sans-serif;
    }
    .btn-gold {
      padding: 10px 20px; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer;
      border: none; background: linear-gradient(135deg, #D4AF37, #F5E6A3); color: #1A1F2E;
      font-family: 'DM Sans', sans-serif; -webkit-appearance: none;
    }
    .btn-purple {
      padding: 10px 20px; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer;
      border: none; background: linear-gradient(135deg, #A78BFA, #C4B5FD); color: #1A1F2E;
      font-family: 'DM Sans', sans-serif; -webkit-appearance: none;
    }
    .btn-ghost {
      padding: 10px 20px; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer;
      border: 1px solid rgba(255,255,255,0.15); background: transparent; color: rgba(255,255,255,0.6);
      font-family: 'DM Sans', sans-serif; -webkit-appearance: none;
    }
    .btn-gold:active, .btn-purple:active { transform: scale(0.97); }

    /* Bottom nav */
    .bottom-nav {
      position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
      width: 100%; max-width: 480px; z-index: 10;
      background: rgba(15,20,25,0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255,255,255,0.06);
      padding: 8px 12px calc(8px + env(safe-area-inset-bottom));
      display: flex; justify-content: space-around;
    }
    .nav-btn {
      display: flex; flex-direction: column; align-items: center; gap: 3px;
      background: none; border: none; cursor: pointer; padding: 6px 12px;
      color: rgba(255,255,255,0.35); transition: all 0.2s; -webkit-appearance: none;
    }
    .nav-btn.active { color: #D4AF37; }
    .nav-btn .icon { font-size: 20px; }
    .nav-btn.active .icon { filter: drop-shadow(0 0 6px rgba(212,175,55,0.4)); }
    .nav-btn .label { font-size: 10px; font-weight: 600; letter-spacing: 0.5px; }
    .nav-dot { width: 4px; height: 4px; border-radius: 50%; background: #D4AF37; margin-top: 1px; }

    /* Page content */
    .page { padding: 0 20px 100px; animation: fadeUp 0.4s ease; }
    .page-header { padding: 20px 0 16px; }
    .page-title { font-family: 'Playfair Display', serif; font-size: 26px; color: #fff; }
    .page-subtitle { color: rgba(255,255,255,0.4); font-size: 13px; margin-top: 4px; }

    /* Type badges */
    .type-badge {
      font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 20px; flex-shrink: 0;
    }

    /* Spot card */
    .spot-card { transition: all 0.3s; cursor: pointer; }
    .spot-card.done { opacity: 0.45; }

    /* Icon containers */
    .icon-box {
      width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center;
      justify-content: center; font-size: 20px; flex-shrink: 0;
    }
    .icon-box-lg { width: 48px; height: 48px; font-size: 24px; }
    .avatar {
      width: 52px; height: 52px; border-radius: 50%; display: flex; align-items: center;
      justify-content: center; font-size: 22px; font-weight: 700; color: #fff;
      font-family: 'Playfair Display', serif;
    }

    /* Grid */
    .quick-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    /* Tags */
    .tag-btn {
      padding: 8px 14px; border-radius: 10px; font-size: 12px; font-weight: 600; cursor: pointer;
      border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.5); transition: all 0.2s; font-family: 'DM Sans', sans-serif;
      -webkit-appearance: none;
    }
    .tag-btn.gold-active { border-color: #D4AF37; background: rgba(212,175,55,0.15); color: #D4AF37; }
    .tag-btn.purple-active { border-color: #A78BFA; background: rgba(167,139,250,0.15); color: #A78BFA; }

    /* Remove button */
    .remove-btn {
      background: rgba(239,68,68,0.1); border: none; color: #EF4444; cursor: pointer;
      width: 28px; height: 28px; border-radius: 8px; font-size: 14px; flex-shrink: 0;
      -webkit-appearance: none;
    }
    .view-btn {
      background: rgba(91,141,239,0.1); border: none; color: #5B8DEF; cursor: pointer;
      width: 32px; height: 32px; border-radius: 8px; font-size: 14px; -webkit-appearance: none;
    }
    .remove-btn-sm {
      background: rgba(239,68,68,0.1); border: none; color: #EF4444; cursor: pointer;
      width: 32px; height: 32px; border-radius: 8px; font-size: 14px; -webkit-appearance: none;
    }

    /* Day timeline */
    .timeline { padding: 8px 0 0 12px; border-left: 2px solid rgba(212,175,55,0.15); margin-left: 20px; }
    .timeline-dot {
      position: absolute; left: -7px; top: 18px; width: 12px; height: 12px; border-radius: 50%;
      border: 2px solid #1A1F2E; display: flex; align-items: center; justify-content: center;
      font-size: 7px; color: #fff;
    }

    /* Misc */
    .gold-text { color: #D4AF37; }
    .section-line {
      width: 20px; height: 1px; background: linear-gradient(90deg, #D4AF37, transparent); display: inline-block;
    }
  </style>
</head>
<body>

<div class="animated-bg">
  <div class="orb1"></div>
  <div class="orb2"></div>
</div>

<div class="app-root" id="app"></div>

<script>
// ‚îÄ‚îÄ‚îÄ State Management ‚îÄ‚îÄ‚îÄ
const STATE = {
  tab: 'dashboard',
  itinerary: loadState('cm_itinerary', getDefaultItinerary()),
  documents: loadState('cm_documents', []),
  tickets: loadState('cm_tickets', []),
  travelers: loadState('cm_travelers', [
    { id:1, name:'', relation:'Self', passport:'', aadhaar:'', dob:'', phone:'', email:'', blood:'', allergies:'', emergency:'' },
    { id:2, name:'', relation:'Wife', passport:'', aadhaar:'', dob:'', phone:'', email:'', blood:'', allergies:'', emergency:'' },
  ]),
  ui: { expandedDay: 1, addingTo: null, viewing: null, editingTraveler: null, viewingTicket: null }
};

function loadState(key, fallback) {
  try { const s = localStorage.getItem(key); return s ? JSON.parse(s) : fallback; }
  catch { return fallback; }
}
function saveState(key, val) {
  try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
}

function getDefaultItinerary() {
  return [
    { id:1, day:"Day 1", date:"Arrival Day", spots:[
      { id:1, name:"Chiang Mai International Airport", time:"10:00 AM", type:"transport", done:false, notes:"Collect luggage, get SIM card at airport" },
      { id:2, name:"Check-in at Hotel", time:"12:00 PM", type:"hotel", done:false, notes:"Early check-in requested" },
      { id:3, name:"Kad Manee Market", time:"3:00 PM", type:"food", done:false, notes:"Try Khao Soi and mango sticky rice" },
      { id:4, name:"Tha Phae Gate Evening Walk", time:"6:00 PM", type:"attraction", done:false, notes:"Beautiful at sunset, street performers" },
    ]},
    { id:2, day:"Day 2", date:"Temples & Culture", spots:[
      { id:5, name:"Doi Suthep Temple", time:"7:00 AM", type:"attraction", done:false, notes:"Go early to avoid crowds. 306 steps!" },
      { id:6, name:"Wat Chedi Luang", time:"11:00 AM", type:"attraction", done:false, notes:"Ancient ruins, monk chat available" },
      { id:7, name:"SP Chicken for Lunch", time:"1:00 PM", type:"food", done:false, notes:"Famous roast chicken, cash only" },
      { id:8, name:"Wat Phra Singh", time:"3:00 PM", type:"attraction", done:false, notes:"Most revered temple in Chiang Mai" },
      { id:9, name:"Night Bazaar", time:"7:00 PM", type:"shopping", done:false, notes:"Bargain! Start at 50% of asking price" },
    ]},
    { id:3, day:"Day 3", date:"Nature & Adventure", spots:[
      { id:10, name:"Elephant Nature Park", time:"8:00 AM", type:"attraction", done:false, notes:"Full day tour, ethical sanctuary" },
      { id:11, name:"Lunch at the Park", time:"12:00 PM", type:"food", done:false, notes:"Buffet included in tour" },
      { id:12, name:"Return & Rest", time:"4:00 PM", type:"hotel", done:false, notes:"Freshen up at hotel" },
      { id:13, name:"Riverside Dinner", time:"7:00 PM", type:"food", done:false, notes:"The Riverside Bar & Restaurant" },
    ]},
    { id:4, day:"Day 4", date:"Markets & Cooking", spots:[
      { id:14, name:"Warorot Market", time:"8:00 AM", type:"shopping", done:false, notes:"Local market, buy spices & dried fruits" },
      { id:15, name:"Thai Cooking Class", time:"10:00 AM", type:"attraction", done:false, notes:"Mama Noi Cooking School - booked!" },
      { id:16, name:"Nimman Road Caf√©s", time:"3:00 PM", type:"food", done:false, notes:"Ristr8to for award-winning latte art" },
      { id:17, name:"MAYA Lifestyle Mall", time:"5:00 PM", type:"shopping", done:false, notes:"Rooftop bar at sunset" },
    ]},
    { id:5, day:"Day 5", date:"Departure", spots:[
      { id:18, name:"Hotel Checkout", time:"9:00 AM", type:"hotel", done:false, notes:"Pack souvenirs carefully" },
      { id:19, name:"Khao Soi Khun Yai", time:"10:30 AM", type:"food", done:false, notes:"Best Khao Soi in town, don't miss!" },
      { id:20, name:"Airport Transfer", time:"1:00 PM", type:"transport", done:false, notes:"Grab taxi or hotel shuttle" },
    ]},
  ];
}

const TYPE_ICONS = { transport:"üöó", hotel:"üè®", food:"üçú", attraction:"‚õ©Ô∏è", shopping:"üõçÔ∏è" };
const TYPE_COLORS = { transport:"#5B8DEF", hotel:"#A78BFA", food:"#F59E0B", attraction:"#EF4444", shopping:"#10B981" };

// ‚îÄ‚îÄ‚îÄ Rendering Engine ‚îÄ‚îÄ‚îÄ
function render() {
  const app = document.getElementById('app');
  let html = '<div style="position:relative;z-index:1">';

  switch(STATE.tab) {
    case 'dashboard': html += renderDashboard(); break;
    case 'itinerary': html += renderItinerary(); break;
    case 'documents': html += renderDocuments(); break;
    case 'tickets': html += renderTickets(); break;
    case 'travelers': html += renderTravelers(); break;
  }

  html += '</div>';
  html += renderNav();
  app.innerHTML = html;
  bindEvents();
}

function renderNav() {
  const tabs = [
    { id:'dashboard', icon:'üè†', label:'Home' },
    { id:'itinerary', icon:'üóìÔ∏è', label:'Itinerary' },
    { id:'documents', icon:'üìÑ', label:'Docs' },
    { id:'tickets', icon:'‚úàÔ∏è', label:'Tickets' },
    { id:'travelers', icon:'üë•', label:'Travelers' },
  ];
  return `<div class="bottom-nav">${tabs.map(t => `
    <button class="nav-btn ${STATE.tab===t.id?'active':''}" onclick="navigate('${t.id}')">
      <span class="icon">${t.icon}</span>
      <span class="label">${t.label}</span>
      ${STATE.tab===t.id ? '<div class="nav-dot"></div>' : ''}
    </button>`).join('')}</div>`;
}

function navigate(tab) { STATE.tab = tab; render(); window.scrollTo(0,0); }

// ‚îÄ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ
function renderDashboard() {
  const total = STATE.itinerary.reduce((a,d) => a + d.spots.length, 0);
  const done = STATE.itinerary.reduce((a,d) => a + d.spots.filter(s=>s.done).length, 0);
  const pct = total ? Math.round((done/total)*100) : 0;
  const C = 2 * Math.PI * 54;
  const offset = C - (pct/100)*C;
  const todayDay = STATE.itinerary.find(d => d.spots.some(s => !s.done)) || STATE.itinerary[0];
  const nextSpots = todayDay ? todayDay.spots.filter(s => !s.done).slice(0,3) : [];

  return `<div class="page">
    <!-- Header -->
    <div style="padding:20px 0 10px;text-align:center">
      <div style="font-size:13px;letter-spacing:3px;color:#D4AF37;font-family:'Cormorant Garamond',serif;text-transform:uppercase;margin-bottom:4px">‚ú¶ Your Journey Awaits ‚ú¶</div>
      <h1 style="font-family:'Playfair Display',serif;font-size:32px;font-weight:700;background:linear-gradient(135deg,#FFFFFF 0%,#D4AF37 50%,#F5E6A3 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:4px 0">Chiang Mai</h1>
      <p style="color:rgba(255,255,255,0.5);font-size:13px">üáπüá≠ Northern Thailand ¬∑ Rose of the North</p>
    </div>

    <!-- Progress -->
    <div class="glass" style="padding:28px;margin:16px 0;text-align:center">
      <div style="position:relative;width:130px;height:130px;margin:0 auto 16px">
        <svg width="130" height="130" style="transform:rotate(-90deg)">
          <circle cx="65" cy="65" r="54" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="8"/>
          <circle cx="65" cy="65" r="54" fill="none" stroke="#D4AF37" stroke-width="8"
            stroke-dasharray="${C}" stroke-dashoffset="${offset}" stroke-linecap="round" style="transition:stroke-dashoffset 1s ease"/>
        </svg>
        <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center">
          <span style="font-family:'Playfair Display',serif;font-size:36px;font-weight:700;color:#D4AF37">${pct}%</span>
          <span style="font-size:11px;color:rgba(255,255,255,0.4);letter-spacing:1px">COMPLETE</span>
        </div>
      </div>
      <div style="display:flex;justify-content:center;gap:32px">
        ${[{n:done,l:'Visited'},{n:total-done,l:'Remaining'},{n:STATE.itinerary.length,l:'Days'}].map(s => `
          <div style="text-align:center">
            <div style="font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:#fff">${s.n}</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.4);letter-spacing:1px;margin-top:2px">${s.l}</div>
          </div>`).join('')}
      </div>
    </div>

    <!-- Quick Access -->
    <div class="quick-grid" style="margin:16px 0">
      ${[
        { icon:'üìÑ', label:'Documents', count:STATE.documents.length, tab:'documents', color:'#5B8DEF' },
        { icon:'üé´', label:'Tickets', count:STATE.tickets.length, tab:'tickets', color:'#A78BFA' },
        { icon:'‚õ©Ô∏è', label:'Places', count:total, tab:'itinerary', color:'#EF4444' },
        { icon:'üë•', label:'Travelers', count:2, tab:'travelers', color:'#10B981' },
      ].map(item => `
        <div class="glass" style="padding:18px;cursor:pointer" onclick="navigate('${item.tab}')">
          <div style="font-size:28px;margin-bottom:8px">${item.icon}</div>
          <div style="font-size:14px;font-weight:600;color:#fff">${item.label}</div>
          <div style="font-size:12px;color:${item.color};margin-top:4px;font-weight:600">${item.count} items</div>
        </div>`).join('')}
    </div>

    <!-- Up Next -->
    ${todayDay ? `
      <h3 style="font-family:'Playfair Display',serif;font-size:18px;color:#D4AF37;margin:24px 0 12px;display:flex;align-items:center;gap:8px">
        <span class="section-line"></span> Up Next ‚Äî ${todayDay.day}
      </h3>
      ${nextSpots.map(spot => `
        <div class="glass" style="padding:14px 16px;margin-bottom:8px;display:flex;align-items:center;gap:12px">
          <div class="icon-box" style="background:${TYPE_COLORS[spot.type]}20;font-size:20px">${TYPE_ICONS[spot.type]}</div>
          <div style="flex:1;min-width:0">
            <div style="font-size:14px;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${spot.name}</div>
            <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:2px">${spot.time}</div>
          </div>
          <span class="type-badge" style="color:${TYPE_COLORS[spot.type]};background:${TYPE_COLORS[spot.type]}15">${spot.type}</span>
        </div>`).join('')}
    ` : ''}

    <!-- Emergency -->
    <div class="glass" style="padding:16px;margin:20px 0;border-color:rgba(239,68,68,0.2)">
      <div style="font-size:13px;font-weight:600;color:#EF4444;margin-bottom:8px">üÜò Emergency Info</div>
      <div style="font-size:12px;color:rgba(255,255,255,0.5);line-height:1.8">
        Tourist Police: <span style="color:#fff">1155</span> &nbsp;¬∑&nbsp;
        Ambulance: <span style="color:#fff">1669</span> &nbsp;¬∑&nbsp;
        Indian Embassy: <span style="color:#fff">+66 2 258 0300</span>
      </div>
    </div>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ Itinerary ‚îÄ‚îÄ‚îÄ
function renderItinerary() {
  return `<div class="page">
    <div class="page-header">
      <h2 class="page-title">Your Itinerary</h2>
      <p class="page-subtitle">Tap spots to mark as visited ‚úì</p>
    </div>
    ${STATE.itinerary.map(day => {
      const doneCount = day.spots.filter(s=>s.done).length;
      const isOpen = STATE.ui.expandedDay === day.id;
      const allDone = doneCount === day.spots.length;
      return `
        <div style="margin-bottom:12px">
          <div class="glass ${isOpen?'glass-active':''}" style="padding:16px;cursor:pointer" onclick="toggleDay(${day.id})">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-family:'Playfair Display',serif;font-size:18px;font-weight:700;color:#D4AF37">${day.day}</div>
                <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:2px">${day.date}</div>
              </div>
              <div style="display:flex;align-items:center;gap:10px">
                <span style="font-size:12px;font-weight:600;padding:4px 12px;border-radius:20px;background:${allDone?'rgba(16,185,129,0.15)':'rgba(212,175,55,0.1)'};color:${allDone?'#10B981':'#D4AF37'}">${doneCount}/${day.spots.length}</span>
                <span style="color:rgba(255,255,255,0.3);font-size:14px;transition:transform 0.3s;display:inline-block;transform:rotate(${isOpen?180:0}deg)">‚ñº</span>
              </div>
            </div>
          </div>
          ${isOpen ? `
            <div class="timeline">
              ${day.spots.map((spot, i) => `
                <div style="position:relative;padding-left:20px;margin-bottom:4px;animation:fadeUp 0.3s ease ${i*0.05}s both">
                  <div class="timeline-dot" style="background:${spot.done?'#10B981':TYPE_COLORS[spot.type]}">${spot.done?'‚úì':''}</div>
                  <div class="glass spot-card ${spot.done?'done':''}" style="padding:14px 16px;margin-bottom:8px" onclick="toggleSpot(${day.id},${spot.id})">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start">
                      <div style="flex:1">
                        <div style="display:flex;align-items:center;gap:8px">
                          <span style="font-size:16px">${TYPE_ICONS[spot.type]}</span>
                          <span style="font-size:14px;font-weight:600;color:#fff;${spot.done?'text-decoration:line-through':''}">${spot.name}</span>
                        </div>
                        <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:6px;padding-left:24px">üïê ${spot.time}</div>
                        ${spot.notes?`<div style="font-size:12px;color:rgba(255,255,255,0.35);margin-top:4px;padding-left:24px;font-style:italic">üí° ${spot.notes}</div>`:''}
                      </div>
                      <button class="remove-btn" onclick="event.stopPropagation();removeSpot(${day.id},${spot.id})">√ó</button>
                    </div>
                  </div>
                </div>`).join('')}

              ${STATE.ui.addingTo === day.id ? `
                <div style="padding-left:20px;margin-bottom:12px">
                  <div class="glass" style="padding:16px">
                    <input id="newSpotName" class="input" placeholder="Spot name..." />
                    <div style="display:flex;gap:8px;margin-top:8px">
                      <input id="newSpotTime" class="input" style="flex:1" placeholder="Time..." />
                      <select id="newSpotType" class="input" style="flex:1">
                        ${Object.entries(TYPE_ICONS).map(([k,v]) => `<option value="${k}">${v} ${k}</option>`).join('')}
                      </select>
                    </div>
                    <input id="newSpotNotes" class="input" style="margin-top:8px" placeholder="Notes (optional)..." />
                    <div style="display:flex;gap:8px;margin-top:12px">
                      <button class="btn-gold" onclick="addSpot(${day.id})">Add Spot</button>
                      <button class="btn-ghost" onclick="STATE.ui.addingTo=null;render()">Cancel</button>
                    </div>
                  </div>
                </div>
              ` : `
                <div style="padding-left:20px;margin-bottom:12px">
                  <button class="btn-ghost" style="width:100%;padding:10px;font-size:13px" onclick="STATE.ui.addingTo=${day.id};render()">+ Add a spot</button>
                </div>
              `}
            </div>
          ` : ''}
        </div>`;
    }).join('')}
  </div>`;
}

function toggleDay(id) { STATE.ui.expandedDay = STATE.ui.expandedDay===id ? null : id; render(); }
function toggleSpot(dayId, spotId) {
  const day = STATE.itinerary.find(d=>d.id===dayId);
  if(day) { const spot = day.spots.find(s=>s.id===spotId); if(spot) spot.done = !spot.done; }
  saveState('cm_itinerary', STATE.itinerary); render();
}
function removeSpot(dayId, spotId) {
  const day = STATE.itinerary.find(d=>d.id===dayId);
  if(day) day.spots = day.spots.filter(s=>s.id!==spotId);
  saveState('cm_itinerary', STATE.itinerary); render();
}
function addSpot(dayId) {
  const name = document.getElementById('newSpotName')?.value;
  if(!name?.trim()) return;
  const day = STATE.itinerary.find(d=>d.id===dayId);
  if(day) day.spots.push({
    id: Date.now(), name, done: false,
    time: document.getElementById('newSpotTime')?.value || '',
    type: document.getElementById('newSpotType')?.value || 'attraction',
    notes: document.getElementById('newSpotNotes')?.value || '',
  });
  STATE.ui.addingTo = null;
  saveState('cm_itinerary', STATE.itinerary); render();
}

// ‚îÄ‚îÄ‚îÄ Documents ‚îÄ‚îÄ‚îÄ
const DOC_TYPES = [
  { id:'passport', label:'Passport', icon:'üõÇ' },
  { id:'aadhaar', label:'Aadhaar Card', icon:'ü™™' },
  { id:'visa', label:'Visa', icon:'üìã' },
  { id:'insurance', label:'Travel Insurance', icon:'üõ°Ô∏è' },
  { id:'other', label:'Other ID', icon:'üìÑ' },
];
let selectedDocType = 'passport';

function renderDocuments() {
  return `<div class="page">
    <div class="page-header">
      <h2 class="page-title">Document Vault</h2>
      <p class="page-subtitle">Securely store your travel documents</p>
    </div>

    <div class="glass" style="padding:20px;margin-bottom:16px">
      <div style="font-size:13px;color:rgba(255,255,255,0.6);margin-bottom:12px;font-weight:600">Upload Document</div>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px">
        ${DOC_TYPES.map(dt => `
          <button class="tag-btn ${selectedDocType===dt.id?'gold-active':''}" onclick="selectedDocType='${dt.id}';render()">${dt.icon} ${dt.label}</button>
        `).join('')}
      </div>
      <input type="file" id="docFileInput" accept="image/*,.pdf" style="display:none" onchange="handleDocUpload(this)" />
      <button class="btn-gold" style="width:100%" onclick="document.getElementById('docFileInput').click()">üì§ Upload ${DOC_TYPES.find(d=>d.id===selectedDocType)?.label}</button>
    </div>

    ${STATE.documents.length === 0 ? `
      <div class="glass" style="padding:40px 20px;text-align:center">
        <div style="font-size:48px;margin-bottom:12px">üîê</div>
        <div style="color:rgba(255,255,255,0.4);font-size:14px">No documents yet. Upload your first one above!</div>
      </div>
    ` : STATE.documents.map(doc => {
      const dt = DOC_TYPES.find(d=>d.id===doc.type) || DOC_TYPES[4];
      return `
        <div class="glass" style="padding:16px;margin-bottom:10px">
          <div style="display:flex;align-items:center;gap:12px">
            <div class="icon-box icon-box-lg" style="background:rgba(212,175,55,0.1)">${dt.icon}</div>
            <div style="flex:1;min-width:0">
              <div style="font-size:14px;font-weight:600;color:#fff">${dt.label}</div>
              <div style="font-size:12px;color:rgba(255,255,255,0.35);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${doc.name} ¬∑ ${doc.uploadedAt}</div>
            </div>
            <button class="view-btn" onclick="STATE.ui.viewing=STATE.ui.viewing===${doc.id}?null:${doc.id};render()">üëÅ</button>
            <button class="remove-btn-sm" onclick="removeDoc(${doc.id})">√ó</button>
          </div>
          ${STATE.ui.viewing===doc.id && doc.data ? `
            <div style="margin-top:12px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.1)">
              ${doc.data.startsWith('data:image') ? `<img src="${doc.data}" style="width:100%;display:block" />` :
                `<div style="padding:20px;text-align:center;color:rgba(255,255,255,0.4);font-size:13px">üìÑ PDF uploaded ‚Äî tap to open in device viewer</div>`}
            </div>
          ` : ''}
        </div>`;
    }).join('')}
  </div>`;
}

function handleDocUpload(input) {
  const file = input.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    STATE.documents.push({
      id: Date.now(), type: selectedDocType, name: file.name,
      data: e.target.result, owner: 'Self',
      uploadedAt: new Date().toLocaleDateString(),
    });
    saveState('cm_documents', STATE.documents); render();
  };
  reader.readAsDataURL(file);
  input.value = '';
}
function removeDoc(id) {
  STATE.documents = STATE.documents.filter(d => d.id !== id);
  saveState('cm_documents', STATE.documents); render();
}

// ‚îÄ‚îÄ‚îÄ Tickets ‚îÄ‚îÄ‚îÄ
const TICKET_TYPES = [
  { id:'flight', label:'Flight Ticket', icon:'‚úàÔ∏è' },
  { id:'hotel', label:'Hotel Booking', icon:'üè®' },
  { id:'activity', label:'Activity/Tour', icon:'üé´' },
  { id:'transport', label:'Transport', icon:'üöå' },
];
let selectedTicketType = 'flight';

function renderTickets() {
  return `<div class="page">
    <div class="page-header">
      <h2 class="page-title">Tickets & Bookings</h2>
      <p class="page-subtitle">All your confirmations in one place</p>
    </div>

    <div class="glass" style="padding:20px;margin-bottom:16px">
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px">
        ${TICKET_TYPES.map(tt => `
          <button class="tag-btn ${selectedTicketType===tt.id?'purple-active':''}" onclick="selectedTicketType='${tt.id}';render()">${tt.icon} ${tt.label}</button>
        `).join('')}
      </div>
      <input id="ticketLabel" class="input" style="margin-bottom:10px" placeholder="Label (e.g. DEL ‚Üí CNX Flight)" />
      <input type="file" id="ticketFileInput" accept="image/*,.pdf" style="display:none" onchange="handleTicketUpload(this)" />
      <button class="btn-purple" style="width:100%" onclick="document.getElementById('ticketFileInput').click()">üì§ Upload Ticket</button>
    </div>

    ${STATE.tickets.length === 0 ? `
      <div class="glass" style="padding:40px 20px;text-align:center">
        <div style="font-size:48px;margin-bottom:12px">üé´</div>
        <div style="color:rgba(255,255,255,0.4);font-size:14px">No tickets yet. Upload your bookings above!</div>
      </div>
    ` : STATE.tickets.map(t => {
      const tt = TICKET_TYPES.find(x=>x.id===t.type) || TICKET_TYPES[0];
      return `
        <div class="glass" style="padding:16px;margin-bottom:10px">
          <div style="display:flex;align-items:center;gap:12px">
            <div class="icon-box icon-box-lg" style="background:rgba(167,139,250,0.1)">${tt.icon}</div>
            <div style="flex:1;min-width:0">
              <div style="font-size:14px;font-weight:600;color:#fff">${t.label}</div>
              <div style="font-size:12px;color:rgba(255,255,255,0.35);margin-top:2px">${tt.label} ¬∑ ${t.uploadedAt}</div>
            </div>
            <button class="view-btn" onclick="STATE.ui.viewingTicket=STATE.ui.viewingTicket===${t.id}?null:${t.id};render()">üëÅ</button>
            <button class="remove-btn-sm" onclick="removeTicket(${t.id})">√ó</button>
          </div>
          ${STATE.ui.viewingTicket===t.id && t.data ? `
            <div style="margin-top:12px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.1)">
              ${t.data.startsWith('data:image') ? `<img src="${t.data}" style="width:100%;display:block" />` :
                `<div style="padding:20px;text-align:center;color:rgba(255,255,255,0.4);font-size:13px">üìÑ PDF uploaded</div>`}
            </div>
          ` : ''}
        </div>`;
    }).join('')}
  </div>`;
}

function handleTicketUpload(input) {
  const file = input.files[0]; if(!file) return;
  const label = document.getElementById('ticketLabel')?.value || file.name;
  const reader = new FileReader();
  reader.onload = (e) => {
    STATE.tickets.push({
      id: Date.now(), type: selectedTicketType, label, name: file.name,
      data: e.target.result, uploadedAt: new Date().toLocaleDateString(),
    });
    saveState('cm_tickets', STATE.tickets); render();
  };
  reader.readAsDataURL(file);
  input.value = '';
}
function removeTicket(id) {
  STATE.tickets = STATE.tickets.filter(t => t.id !== id);
  saveState('cm_tickets', STATE.tickets); render();
}

// ‚îÄ‚îÄ‚îÄ Travelers ‚îÄ‚îÄ‚îÄ
function renderTravelers() {
  return `<div class="page">
    <div class="page-header">
      <h2 class="page-title">Travelers</h2>
      <p class="page-subtitle">Your travel party details</p>
    </div>
    ${STATE.travelers.map(t => `
      <div class="glass" style="padding:20px;margin-bottom:12px">
        ${STATE.ui.editingTraveler===t.id ? renderTravelerEdit(t) : renderTravelerView(t)}
      </div>
    `).join('')}
  </div>`;
}

function renderTravelerEdit(t) {
  const fields = [
    { k:'name', l:'Full Name', p:'Full name as on passport' },
    { k:'relation', l:'Relation', p:'e.g. Self, Wife' },
    { k:'passport', l:'Passport No.', p:'Passport number' },
    { k:'aadhaar', l:'Aadhaar No.', p:'Aadhaar number' },
    { k:'dob', l:'Date of Birth', p:'DD/MM/YYYY' },
    { k:'phone', l:'Phone', p:'Phone number' },
    { k:'email', l:'Email', p:'Email address' },
    { k:'blood', l:'Blood Group', p:'e.g. O+, A-, B+' },
    { k:'allergies', l:'Allergies/Medical', p:'Any allergies or conditions' },
    { k:'emergency', l:'Emergency Contact', p:'Name & phone' },
  ];
  return `
    <div style="font-size:13px;color:#D4AF37;font-weight:600;margin-bottom:12px">‚úèÔ∏è Edit Details</div>
    ${fields.map(f => `
      <div style="margin-bottom:8px">
        <label style="font-size:11px;color:rgba(255,255,255,0.4);letter-spacing:0.5px;display:block;margin-bottom:4px">${f.l}</label>
        <input class="input" id="tf_${t.id}_${f.k}" value="${t[f.k]||''}" placeholder="${f.p}" />
      </div>
    `).join('')}
    <div style="display:flex;gap:8px;margin-top:14px">
      <button class="btn-gold" onclick="saveTraveler(${t.id})">Save</button>
      <button class="btn-ghost" onclick="STATE.ui.editingTraveler=null;render()">Cancel</button>
    </div>`;
}

function renderTravelerView(t) {
  const grad = t.id===1 ? 'linear-gradient(135deg,#5B8DEF,#A78BFA)' : 'linear-gradient(135deg,#F59E0B,#EF4444)';
  const infoItems = [
    { l:'Passport', v:t.passport, i:'üõÇ' }, { l:'Aadhaar', v:t.aadhaar, i:'ü™™' },
    { l:'DOB', v:t.dob, i:'üéÇ' }, { l:'Blood', v:t.blood, i:'ü©∏' },
    { l:'Phone', v:t.phone, i:'üì±' }, { l:'Email', v:t.email, i:'üìß' },
  ].filter(x => x.v);

  return `
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div style="display:flex;align-items:center;gap:12px">
        <div class="avatar" style="background:${grad}">${(t.name||'?')[0]}</div>
        <div>
          <div style="font-family:'Playfair Display',serif;font-size:18px;font-weight:700;color:#fff">${t.name||'Tap edit to add name'}</div>
          <div style="font-size:12px;color:#D4AF37;margin-top:2px">${t.relation||'Relation'}</div>
        </div>
      </div>
      <button class="btn-ghost" style="padding:6px 14px;font-size:12px" onclick="STATE.ui.editingTraveler=${t.id};render()">‚úèÔ∏è Edit</button>
    </div>
    ${infoItems.length ? `
      <div class="info-grid" style="margin-top:16px">
        ${infoItems.map(item => `
          <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:10px 12px">
            <div style="font-size:10px;color:rgba(255,255,255,0.35);letter-spacing:1px;margin-bottom:3px">${item.i} ${item.l}</div>
            <div style="font-size:13px;color:#fff;font-weight:500">${item.v}</div>
          </div>`).join('')}
      </div>` : ''}
    ${t.allergies ? `
      <div style="margin-top:10px;background:rgba(239,68,68,0.08);border-radius:10px;padding:10px 12px">
        <div style="font-size:10px;color:rgba(239,68,68,0.6);letter-spacing:1px;margin-bottom:3px">‚ö†Ô∏è MEDICAL</div>
        <div style="font-size:13px;color:#EF4444">${t.allergies}</div>
      </div>` : ''}
    ${t.emergency ? `
      <div style="margin-top:10px;background:rgba(16,185,129,0.08);border-radius:10px;padding:10px 12px">
        <div style="font-size:10px;color:rgba(16,185,129,0.6);letter-spacing:1px;margin-bottom:3px">üÜò EMERGENCY CONTACT</div>
        <div style="font-size:13px;color:#10B981">${t.emergency}</div>
      </div>` : ''}`;
}

function saveTraveler(id) {
  const t = STATE.travelers.find(x=>x.id===id);
  if(!t) return;
  ['name','relation','passport','aadhaar','dob','phone','email','blood','allergies','emergency'].forEach(k => {
    const el = document.getElementById(`tf_${id}_${k}`);
    if(el) t[k] = el.value;
  });
  STATE.ui.editingTraveler = null;
  saveState('cm_travelers', STATE.travelers); render();
}

function bindEvents() { /* events are inline */ }

// ‚îÄ‚îÄ‚îÄ Register Service Worker for offline ‚îÄ‚îÄ‚îÄ
if ('serviceWorker' in navigator) {
  const SW_CODE = `
    const CACHE = 'cm-trip-v1';
    const URLS = ['/'];
    self.addEventListener('install', e => e.waitUntil(caches.open(CACHE).then(c => c.addAll(URLS))));
    self.addEventListener('fetch', e => e.respondWith(
      caches.match(e.request).then(r => r || fetch(e.request).then(resp => {
        const clone = resp.clone();
        caches.open(CACHE).then(c => c.put(e.request, clone));
        return resp;
      }).catch(() => caches.match('/')))
    ));
  `;
  const blob = new Blob([SW_CODE], { type: 'application/javascript' });
  navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(() => {});
}

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
render();
</script>
</body>
</html>
